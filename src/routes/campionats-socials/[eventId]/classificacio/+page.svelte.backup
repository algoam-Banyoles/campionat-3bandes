<script lang="ts">
  import { onMount } from 'svelte';
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import Banner from '$lib/components/general/Banner.svelte';
  import Loader from '$lib/components/general/Loader.svelte';
  import { formatSupabaseError } from '$lib/ui/alerts';

  let loading = true;
  let error: string | null = null;
  let event: any = null;
  let classificacio: any[] = [];
  let categories: any[] = [];

  const eventId = $page.params.eventId;

  const modalityNames = {
    'tres_bandes': '3 Bandes',
    'lliure': 'Lliure',
    'banda': 'Banda'
  };

  const competitionTypes = {
    'lliga_social': 'Campionat Social',
    'eliminatories': 'Eliminat√≤ries'
  };

  onMount(async () => {
    try {
      loading = true;
      await Promise.all([loadEvent(), loadClassification()]);
    } catch (e) {
      error = formatSupabaseError(e);
    } finally {
      loading = false;
    }
  });

  async function loadEvent() {
    const { supabase } = await import('$lib/supabaseClient');

    const { data, error: eventError } = await supabase
      .from('events')
      .select(`
        *,
        categories (
          id,
          nom,
          distancia_caramboles,
          ordre_categoria
        )
      `)
      .eq('id', eventId)
      .single();

    if (eventError) throw eventError;

    event = data;
    categories = data.categories || [];

    // Check if event is a social league
    if (!['lliga_social', 'eliminatories'].includes(event.tipus_competicio)) {
      error = 'Aquest event no √©s un campionat social o eliminat√≤ria';
      return;
    }
  }

  async function loadClassification() {
    const { supabase } = await import('$lib/supabaseClient');

    // First try to get classification data from classificacions table
    const { data: classificacionsData, error: classificacionsError } = await supabase
      .from('classificacions')
      .select(`
        *,
        player:players (
          id,
          nom,
          email,
          numero_soci
        ),
        categoria:categories (
          id,
          nom,
          ordre_categoria,
          distancia_caramboles
        )
      `)
      .eq('event_id', eventId)
      .order('posicio', { ascending: true });

    if (classificacionsError) {
      console.error('Error loading classificacions:', classificacionsError);
      
      // Fallback to inscriptions if no classificacions data
      const { data: inscriptionsData, error: inscriptionsError } = await supabase
        .from('inscripcions')
        .select(`
          *,
          socis (
            numero_soci,
            nom,
            cognoms
          ),
          categoria_assignada:categories (
            id,
            nom,
            ordre_categoria,
            distancia_caramboles
          )
        `)
        .eq('event_id', eventId)
        .eq('confirmat', true)
        .order('data_inscripcio', { ascending: true });

      if (inscriptionsError) throw inscriptionsError;

      // Group inscriptions by category (fallback for events without final classification)
      const groupedByCategory = {};

      inscriptionsData?.forEach(inscription => {
        const categoryId = inscription.categoria_assignada_id || 'sense_categoria';
        const categoryName = inscription.categoria_assignada?.nom || 'Sense categoria';

        if (!groupedByCategory[categoryId]) {
          groupedByCategory[categoryId] = {
            category: inscription.categoria_assignada || { nom: 'Sense categoria', ordre_categoria: 999 },
            participants: []
          };
        }

        groupedByCategory[categoryId].participants.push({
          ...inscription,
          posicio: groupedByCategory[categoryId].participants.length + 1,
          isInscription: true // Flag to show this is inscription data, not final results
        });
      });

      // Convert to array and sort by category order
      classificacio = Object.values(groupedByCategory).sort((a: any, b: any) =>
        (a.category.ordre_categoria || 999) - (b.category.ordre_categoria || 999)
      );
      return;
    }

    // Process real classification data
    const groupedByCategory = {};

    classificacionsData?.forEach(classification => {
      const categoryId = classification.categoria_id || 'sense_categoria';
      const categoryName = classification.categoria?.nom || 'Sense categoria';

      if (!groupedByCategory[categoryId]) {
        groupedByCategory[categoryId] = {
          category: classification.categoria || { nom: 'Sense categoria', ordre_categoria: 999 },
          participants: []
        };
      }

      groupedByCategory[categoryId].participants.push({
        ...classification,
        isClassification: true // Flag to show this is final classification data
      });
    });

    // Group by category and add position within category
    const legacyGroupedByCategory = {};

    // Handle legacy format if needed
    if (Object.keys(groupedByCategory).length === 0) {
      // This section is for legacy data if needed
      const { data: inscriptionsData } = await supabase
        .from('inscripcions')
        .select(`
          *,
          socis (
            numero_soci,
            nom,
            cognoms
          ),
          categoria_assignada:categories (
            id,
            nom,
            ordre_categoria,
            distancia_caramboles
          )
        `)
        .eq('event_id', eventId)
        .eq('confirmat', true)
        .order('data_inscripcio', { ascending: true });

      inscriptionsData?.forEach(inscription => {
        const categoryId = inscription.categoria_assignada_id || 'sense_categoria';

        if (!legacyGroupedByCategory[categoryId]) {
          legacyGroupedByCategory[categoryId] = {
            category: inscription.categoria_assignada || { nom: 'Sense categoria', ordre_categoria: 999 },
            participants: []
          };
        }

        legacyGroupedByCategory[categoryId].participants.push({
          ...inscription,
          posicio: legacyGroupedByCategory[categoryId].participants.length + 1,
          isInscription: true // Flag for legacy data
        });
      });
    }

    // Convert to array and sort by category order
    classificacio = Object.keys(groupedByCategory).length > 0 
      ? Object.values(groupedByCategory).sort((a: any, b: any) =>
          (a.category.ordre_categoria || 999) - (b.category.ordre_categoria || 999)
        )
      : Object.values(legacyGroupedByCategory).sort((a: any, b: any) =>
          (a.category.ordre_categoria || 999) - (b.category.ordre_categoria || 999)
        );
  }

  function getPlayerAverage(inscription: any) {
    // Try to extract average from observacions
    const observacions = inscription.observacions || '';
    const avgMatch = observacions.match(/Mitjana hist√≤rica: ([\d.]+)/);
    return avgMatch ? parseFloat(avgMatch[1]).toFixed(2) : '-';
  }
</script>

<svelte:head>
  <title>Classificaci√≥ - {event?.nom || 'Lliga Social'}</title>
</svelte:head>

<div class="max-w-6xl mx-auto p-4">
  <div class="mb-6">
    <div class="flex items-center space-x-4 mb-2">
      <a
        href="/campionats-socials/{eventId}"
        class="text-gray-600 hover:text-gray-900"
      >
        ‚Üê Tornar a l'event
      </a>
    </div>

    {#if event}
      <h1 class="text-2xl font-semibold text-gray-900">Classificaci√≥</h1>
      <div class="flex items-center space-x-4 text-sm text-gray-600 mt-1">
        <span>{event.nom}</span>

    if (classificacionsError) {
      console.error('Error loading classificacions:', classificacionsError);
      
      // Fallback to inscriptions if no classificacions data
      const { data: inscriptionsData, error: inscriptionsError } = await supabase
        .from('inscripcions')
        .select(`
          *,
          socis (
            numero_soci,
            nom,
            cognoms
          ),
          categoria_assignada:categories (
            id,
            nom,
            ordre_categoria,
            distancia_caramboles
          )
        `)
        .eq('event_id', eventId)
        .eq('confirmat', true)
        .order('data_inscripcio', { ascending: true });

      if (inscriptionsError) throw inscriptionsError;

      // Group inscriptions by category (fallback for events without final classification)
      const groupedByCategory = {};

      inscriptionsData?.forEach(inscription => {
        const categoryId = inscription.categoria_assignada_id || 'sense_categoria';
        const categoryName = inscription.categoria_assignada?.nom || 'Sense categoria';

        if (!groupedByCategory[categoryId]) {
          groupedByCategory[categoryId] = {
            category: inscription.categoria_assignada || { nom: 'Sense categoria', ordre_categoria: 999 },
            participants: []
          };
        }

        groupedByCategory[categoryId].participants.push({
          ...inscription,
          posicio: groupedByCategory[categoryId].participants.length + 1,
          isInscription: true // Flag to show this is inscription data, not final results
        });
      });

      // Convert to array and sort by category order
      classificacio = Object.values(groupedByCategory).sort((a: any, b: any) =>
        (a.category.ordre_categoria || 999) - (b.category.ordre_categoria || 999)
      );
      return;
    }

    // Process real classification data
    const groupedByCategory = {};

    classificacionsData?.forEach(classification => {
      const categoryId = classification.categoria_id || 'sense_categoria';
      const categoryName = classification.categoria?.nom || 'Sense categoria';

      if (!groupedByCategory[categoryId]) {
        groupedByCategory[categoryId] = {
          category: classification.categoria || { nom: 'Sense categoria', ordre_categoria: 999 },
          participants: []
        };
      }

      groupedByCategory[categoryId].participants.push({
        ...classification,
        isClassification: true // Flag to show this is final classification data
      });
    });

    // Group by category and add position within category
    const legacyGroupedByCategory = {};

    // Handle legacy format if needed
    if (Object.keys(groupedByCategory).length === 0) {
      inscriptionsData?.forEach(inscription => {
        const categoryId = inscription.categoria_assignada_id || 'sense_categoria';
        const categoryName = inscription.categoria_assignada?.nom || 'Sense categoria';

      if (!groupedByCategory[categoryId]) {
        groupedByCategory[categoryId] = {
          category: inscription.categoria_assignada || { nom: 'Sense categoria', ordre_categoria: 999 },
          participants: []
        };
      }

      groupedByCategory[categoryId].participants.push({
        ...inscription,
        posicio: groupedByCategory[categoryId].participants.length + 1
      });
    });

    // Convert to array and sort by category order
    classificacio = Object.values(groupedByCategory).sort((a: any, b: any) =>
      (a.category.ordre_categoria || 999) - (b.category.ordre_categoria || 999)
    );
  }

  function getPlayerAverage(inscription: any) {
    // Try to extract average from observacions
    const observacions = inscription.observacions || '';
    const avgMatch = observacions.match(/Mitjana hist√≤rica: ([\d.]+)/);
    return avgMatch ? parseFloat(avgMatch[1]).toFixed(2) : '-';
  }
</script>

<svelte:head>
  <title>Classificaci√≥ - {event?.nom || 'Lliga Social'}</title>
</svelte:head>

<div class="max-w-6xl mx-auto p-4">
  <div class="mb-6">
    <div class="flex items-center space-x-4 mb-2">
      <a
        href="/campionats-socials/{eventId}"
        class="text-gray-600 hover:text-gray-900"
      >
        ‚Üê Tornar a l'event
      </a>
    </div>

    {#if event}
      <h1 class="text-2xl font-semibold text-gray-900">Classificaci√≥</h1>
      <div class="flex items-center space-x-4 text-sm text-gray-600 mt-1">
        <span>{event.nom}</span>
        <span>‚Ä¢</span>
        <span>{modalityNames[event.modalitat]}</span>
        <span>‚Ä¢</span>
        <span>{event.temporada}</span>
        <span>‚Ä¢</span>
        <span>{competitionTypes[event.tipus_competicio]}</span>
      </div>
    {/if}
  </div>

  {#if loading}
    <Loader />
  {:else if error}
    <Banner type="error" message={error} />
  {:else if event}
    {#if classificacio.length === 0}
      <div class="text-center py-12 bg-white rounded-lg shadow">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No hi ha participants</h3>
        <p class="mt-1 text-sm text-gray-500">Aquest event encara no t√© participants confirmats</p>
      </div>
    {:else}
      <!-- Classification by Categories -->
      <div class="space-y-8">
        {#each classificacio as categoryGroup}
          <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="bg-gray-50 px-6 py-3 border-b">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-medium text-gray-900">
                    {categoryGroup.category.nom}
                  </h3>
                  {#if categoryGroup.participants[0]?.isClassification}
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 mt-1">
                      üìä Classificaci√≥ Final
                    </span>
                  {:else}
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800 mt-1">
                      üìã Llista d'Inscripcions
                    </span>
                  {/if}
                </div>
                {#if categoryGroup.category.distancia_caramboles}
                  <span class="text-sm text-gray-500">
                    {categoryGroup.category.distancia_caramboles} caramboles
                  </span>
                {/if}
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Pos.
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Jugador
                    </th>
                    {#if categoryGroup.participants[0]?.isClassification}
                      <!-- Final classification columns -->
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Partides
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        G-P-E
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Punts
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Caramboles
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Mitjana
                      </th>
                    {:else}
                      <!-- Inscription fallback columns -->
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Mitjana Hist√≤rica
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Data Inscripci√≥
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Estat
                      </th>
                    {/if}
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  {#each categoryGroup.participants as participant, i}
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {participant.posicio || (i + 1)}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <div>
                            {#if participant.isClassification}
                              <div class="text-sm font-medium text-gray-900">
                                {participant.player?.nom || 'Nom no disponible'}
                              </div>
                              <div class="text-sm text-gray-500">
                                Soci #{participant.player?.numero_soci || 'N/A'}
                              </div>
                            {:else}
                              <div class="text-sm font-medium text-gray-900">
                                {participant.socis?.nom} {participant.socis?.cognoms}
                              </div>
                              <div class="text-sm text-gray-500">
                                Soci #{participant.socis?.numero_soci}
                              </div>
                            {/if}
                          </div>
                        </div>
                      </td>
                      {#if participant.isClassification}
                        <!-- Final classification data -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {participant.partides_jugades || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {participant.partides_guanyades || 0}-{participant.partides_perdudes || 0}-{participant.partides_empat || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                          {participant.punts || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {participant.caramboles_favor || 0}/{participant.caramboles_contra || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {participant.mitjana_particular ? participant.mitjana_particular.toFixed(3) : '0.000'}
                        </td>
                      {:else}
                        <!-- Inscription fallback data -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {getPlayerAverage(participant)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {participant.data_inscripcio ? new Date(participant.data_inscripcio).toLocaleDateString('ca-ES') : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {participant.confirmat ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                              {participant.confirmat ? 'Confirmat' : 'Pendent'}
                            </span>
                            {#if event.quota_inscripcio > 0}
                              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {participant.pagat ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                {participant.pagat ? 'Pagat' : 'Pendent pagament'}
                              </span>
                            {/if}
                          </div>
                        </td>
                      {/if}
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>

            <!-- Category summary -->
            <div class="bg-gray-50 px-6 py-3 border-t">
              <p class="text-sm text-gray-600">
                <strong>{categoryGroup.participants.length}</strong> participant{categoryGroup.participants.length !== 1 ? 's' : ''}
                {#if categoryGroup.category.distancia_caramboles}
                  ‚Ä¢ Dist√†ncia: {categoryGroup.category.distancia_caramboles} caramboles
                {/if}
              </p>
            </div>
          </div>
        {/each}
      </div>

      <!-- Event summary -->
      <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-lg font-medium text-blue-900 mb-2">Resum de l'Event</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="font-medium text-blue-800">Total participants:</span>
            <span class="text-blue-700">{classificacio.reduce((sum, cat) => sum + cat.participants.length, 0)}</span>
          </div>
          <div>
            <span class="font-medium text-blue-800">Categories:</span>
            <span class="text-blue-700">{classificacio.length}</span>
          </div>
          <div>
            <span class="font-medium text-blue-800">Modalitat:</span>
            <span class="text-blue-700">{modalityNames[event.modalitat]}</span>
          </div>
        </div>
      </div>
    {/if}
  {/if}
</div>